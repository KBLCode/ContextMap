# PLAN: ContextViewer - Real-time Token Usage Visualization

Date: 2026-01-15
Status: Draft

## REQUIRED SKILLS - LOAD BEFORE PROCEEDING
<!-- Upon reading this plan, immediately load the following skills: -->
skill({ name: "typescript" })
skill({ name: "async-patterns" })

## Overview

A real-time token usage visualization plugin for both OpenCode and Claude Code that displays input/output token flow as a DNA helix-style braille graph with context usage bar.

## Visual Design (Approved)

### Real-time Widget (Always Visible)

```
╭─ tokens ─────────────────────────────────────────────────────╮
│ ⣀⣤⣶⣿⣶⣤⣀⣀⣤⣶⣿⣿⣿⣶⣤⣀⣀⣤⣶⣿⣶⣤⣀⣀⣤⣶⣿⣿⣿⣿⣶⣤⣀  IN 2.4k  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ ⠉⠛⠿⣿⠿⠛⠉⠉⠛⠉⠉⠉⠉⠉⠛⠉⠉⠛⠿⣿⠿⠛⠉⠉⠉⠉⠉⠉⠉⠉⠛⠉⠉  OUT 892  │
│ ──────────────────────────────────────────────────────────── │
│ ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣶⣶⣤⣤⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀ 82% +1.5k $0 │
╰──────────────────────────────────────────────────────────────╯
```

**Design Elements:**
- Line 1: Input tokens (peaks pointing UP/north) - braille density
- Line 2: Center axis separator (━━━)
- Line 3: Output tokens (peaks pointing DOWN/south) - braille density  
- Line 4: Thin separator line (──────)
- Line 5: Context usage bar (braille gradient) + stats

### `/cmap` Command - 24-Hour Historical View

Full-screen historical visualization triggered by `/cmap` command:

```
╭─ Context Map ─ Last 24 Hours ────────────────────────────────────────────────╮
│                                                                              │
│  INPUT TOKENS                                                                │
│  ⣀⣤⣶⣿⣶⣤⣀⣀⣤⣶⣿⣿⣿⣶⣤⣀⣀⣤⣶⣿⣶⣤⣀⣀⣤⣶⣿⣿⣿⣿⣶⣤⣀⣀⣤⣶⣿⣶⣤⣀⣀⣤⣶⣿⣿⣿⣶⣤⣀⣀⣤⣶⣿⣶⣤⣀  │
│  ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿  │
│  ⠉⠛⠿⣿⠿⠛⠉⠉⠛⠉⠉⠉⠉⠉⠛⠉⠉⠛⠿⣿⠿⠛⠉⠉⠉⠉⠉⠉⠉⠉⠛⠉⠉⠛⠿⣿⠿⠛⠉⠉⠛⠉⠉⠉⠉⠉⠛⠉⠉⠛⠿⣿⠿⠛⠉⠉  │
│  OUTPUT TOKENS                                                               │
│                                                                              │
│  00:00    04:00    08:00    12:00    16:00    20:00    NOW                   │
│  ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤               │
│                                                                              │
│ ┌─ Session Summary ──────────────────────────────────────────────────────┐   │
│ │  SESSIONS: 12        MESSAGES: 847       COMPACTIONS: 3                │   │
│ │  TOTAL IN: 1.2M      TOTAL OUT: 456k     CACHE HITS: 78%               │   │
│ │  PEAK IN:  45k       PEAK OUT:  12k      AVG CTX: 67%                  │   │
│ └────────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│ ┌─ Per-Session Breakdown ────────────────────────────────────────────────┐   │
│ │  #1  ████████████████░░░░  145k in   42k out   23 msgs   ⟳ compacted   │   │
│ │  #2  ██████████░░░░░░░░░░   89k in   31k out   15 msgs                 │   │
│ │  #3  ████████████████████  198k in   67k out   34 msgs   ⟳ compacted   │   │
│ │  #4  ██████░░░░░░░░░░░░░░   52k in   18k out    8 msgs   ← current     │   │
│ └────────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
╰──────────────────────────────────────────────────────────────────────────────╯
```

**`/cmap` Features:**
- 24-hour rolling window of token usage
- Input/output mirrored graph (same DNA helix style, expanded)
- Time axis with hour markers
- Session summary statistics
- Per-session breakdown with:
  - Token usage bars
  - Message counts
  - Compaction indicators (⟳)
  - Current session marker (←)

## Context

Both OpenCode and Claude Code lack real-time visualization of token usage during conversations. Users have no visual feedback on:
- How much context they're consuming per message
- The balance between input and output tokens
- When they're approaching context limits
- Historical token usage patterns

This plugin provides at-a-glance token monitoring without leaving the coding environment.

## Scope

### In Scope
- OpenCode plugin (TypeScript/JavaScript)
- Claude Code plugin (TypeScript)
- Real-time token tracking from API responses
- Braille-based ASCII visualization
- Color support (ANSI terminal colors)
- Context window percentage tracking
- Session totals and per-message stats
- Rolling history graph (last N messages)
- **Context reset on compaction** - Reset context bar when session compacts
- **`/cmap` command** - 24-hour historical view with session breakdown
- **Persistent storage** - SQLite/JSON for 24-hour history

### Out of Scope
- Cost tracking (handled separately, shown but not calculated)
- Web UI version
- Integration with other AI providers (initially)

## Architecture

### Data Flow

```
API Response → Token Extractor → History Buffer → Renderer → Terminal Output
                    ↓
              usage.input_tokens
              usage.output_tokens
              usage.cache_read_input_tokens
              usage.cache_creation_input_tokens
```

### Core Components

1. **TokenTracker** - Extracts and stores token counts from API responses
2. **HistoryBuffer** - Circular buffer storing last N message token counts
3. **BrailleRenderer** - Converts token values to braille characters
4. **ContextBar** - Renders context usage as gradient bar
5. **Widget** - Combines all elements into final display
6. **PersistentStore** - SQLite/JSON storage for 24-hour history
7. **SessionManager** - Tracks sessions, compactions, and resets
8. **CmapRenderer** - Full-screen `/cmap` historical view

### File Structure

```
ContextViewer/
├── .gitignore
├── README.md
├── LICENSE
├── package.json
├── tsconfig.json
├── docs/
│   └── PLAN_2026-01-15.md
├── src/
│   ├── core/
│   │   ├── token-tracker.ts      # Token extraction logic
│   │   ├── history-buffer.ts     # Circular buffer for history
│   │   ├── braille-renderer.ts   # Braille character mapping
│   │   ├── context-bar.ts        # Context usage bar
│   │   ├── persistent-store.ts   # SQLite/JSON 24-hour storage
│   │   ├── session-manager.ts    # Session & compaction tracking
│   │   └── cmap-renderer.ts      # /cmap full-screen view
│   ├── opencode/
│   │   ├── plugin.ts             # OpenCode plugin entry
│   │   ├── commands/
│   │   │   └── cmap.ts           # /cmap command handler
│   │   └── index.ts              # Export
│   ├── claude-code/
│   │   ├── plugin.ts             # Claude Code plugin entry
│   │   ├── commands/
│   │   │   └── cmap.md           # /cmap command (markdown)
│   │   └── index.ts              # Export
│   └── shared/
│       ├── types.ts              # Shared TypeScript types
│       ├── constants.ts          # Braille chars, colors, etc.
│       └── utils.ts              # Helper functions
├── data/                         # Runtime data (gitignored)
│   └── history.db                # SQLite database
├── dist/                         # Compiled output
│   ├── opencode/
│   └── claude-code/
└── examples/
    └── demo.ts                   # Standalone demo
```

## Implementation Steps

### Phase 1: Core Library (Day 1)
1. [ ] Set up project structure and TypeScript config
2. [ ] Implement `HistoryBuffer` - circular buffer for token history
3. [ ] Implement `BrailleRenderer` - map values to braille characters
4. [ ] Implement `ContextBar` - gradient context usage bar
5. [ ] Implement `PersistentStore` - SQLite storage for 24-hour history
6. [ ] Implement `SessionManager` - session and compaction tracking
7. [ ] Create shared types and constants
8. [ ] Write unit tests for core components

### Phase 2: OpenCode Plugin (Day 2)
1. [ ] Create OpenCode plugin structure
2. [ ] Hook into `message.part.updated` event for streaming tokens
3. [ ] Hook into `session.idle` event for final token counts
4. [ ] Hook into `session.compacted` event for context reset
5. [ ] Hook into `session.created` event for new sessions
6. [ ] Implement TUI rendering (investigate OpenCode TUI hooks)
7. [ ] Add color support via ANSI codes
8. [ ] Test with live OpenCode session

### Phase 3: `/cmap` Command (Day 3)
1. [ ] Implement `CmapRenderer` - full-screen historical view
2. [ ] Create OpenCode `/cmap` custom tool
3. [ ] Create Claude Code `/cmap` slash command
4. [ ] Add time axis rendering with hour markers
5. [ ] Add session breakdown table
6. [ ] Add compaction markers (⟳)
7. [ ] Test 24-hour data retrieval and display

### Phase 4: Claude Code Plugin (Day 4)
1. [ ] Create Claude Code plugin structure (`.claude-plugin/plugin.json`)
2. [ ] Implement hooks for token tracking
3. [ ] Adapt renderer for Claude Code's display system
4. [ ] Test with live Claude Code session

### Phase 5: Polish & Release (Day 5)
1. [ ] Add configuration options (width, colors, position)
2. [ ] Write comprehensive README with screenshots
3. [ ] Create demo GIF/video
4. [ ] Publish to npm (optional)
5. [ ] Submit to OpenCode ecosystem
6. [ ] Submit to Claude Code plugin marketplace (if applicable)

## Technical Details

### Braille Character Mapping

```typescript
// Braille patterns for vertical bars (8 levels)
const BRAILLE_UP = ['⠀', '⣀', '⣤', '⣶', '⣿']; // peaks up (for input)
const BRAILLE_DOWN = ['⠀', '⠉', '⠛', '⠿', '⣿']; // peaks down (for output)

// Context bar gradient
const CONTEXT_GRADIENT = ['⠀', '⣀', '⣤', '⣶', '⣿'];
```

### Token Extraction (OpenCode)

```typescript
// OpenCode provides token usage in message events
export const ContextViewerPlugin: Plugin = async ({ client }) => {
  const tracker = new TokenTracker();
  const store = new PersistentStore();
  const sessionManager = new SessionManager(store);
  
  return {
    event: async ({ event }) => {
      if (event.type === "message.part.updated") {
        // Extract usage from streaming response
        const usage = event.properties?.message?.usage;
        if (usage) {
          const record = {
            input: usage.input_tokens,
            output: usage.output_tokens,
            cacheRead: usage.cache_read_input_tokens,
            cacheWrite: usage.cache_creation_input_tokens,
            timestamp: Date.now(),
          };
          tracker.record(record);
          store.append(record); // Persist for /cmap
        }
      }
      
      // COMPACTION HANDLING - Reset context on compaction
      if (event.type === "session.compacted") {
        tracker.resetContext(); // Reset context bar to 0%
        sessionManager.markCompaction(); // Record compaction event
        renderWidget(tracker); // Show reset state
      }
      
      if (event.type === "session.idle") {
        // Render updated widget
        renderWidget(tracker);
      }
      
      // New session started
      if (event.type === "session.created") {
        sessionManager.newSession();
        tracker.reset();
      }
    },
  };
};
```

### Compaction Behavior

When a session compacts:
1. **Context bar resets to 0%** - Fresh context window
2. **Compaction marker added** - ⟳ symbol in `/cmap` view
3. **History preserved** - Token history continues for 24-hour view
4. **Session continues** - Same session, just compacted

### Token Extraction (Claude Code)

```typescript
// Claude Code uses hooks system
// hooks/hooks.json
{
  "hooks": {
    "PostMessage": [
      {
        "matcher": ".*",
        "hooks": [{ "type": "command", "command": "node track-tokens.js" }]
      }
    ]
  }
}
```

### `/cmap` Command Implementation

**OpenCode** - Custom tool in plugin:

```typescript
// src/opencode/commands/cmap.ts
import { tool } from "@opencode-ai/plugin";
import { CmapRenderer } from "../../core/cmap-renderer";
import { PersistentStore } from "../../core/persistent-store";

export const cmapTool = tool({
  description: "Show 24-hour token usage map with session breakdown",
  args: {
    hours: tool.schema.number().optional().default(24),
  },
  async execute(args, ctx) {
    const store = new PersistentStore();
    const history = store.getHistory(args.hours);
    const renderer = new CmapRenderer();
    return renderer.render(history);
  },
});
```

**Claude Code** - Slash command markdown:

```markdown
<!-- commands/cmap.md -->
---
description: Show 24-hour token usage map with session breakdown
---

# Context Map

Display the 24-hour token usage history.

Run the context-viewer cmap tool to show:
- Input/output token graph over time
- Session summaries and compaction markers
- Total statistics

$ARGUMENTS can specify hours (default: 24)
```

### Persistent Storage Schema

```typescript
// SQLite schema for 24-hour history
interface TokenRecord {
  id: number;
  timestamp: number;        // Unix ms
  session_id: string;       // UUID
  input_tokens: number;
  output_tokens: number;
  cache_read: number;
  cache_write: number;
  context_pct: number;      // 0-100
  is_compaction: boolean;   // True if this was a compaction event
}

// Cleanup: Delete records older than 24 hours on startup
// Index on timestamp for fast range queries
```

### Rendering Logic

```typescript
function renderWidget(tracker: TokenTracker): string {
  const history = tracker.getHistory(40); // last 40 data points
  const latest = tracker.getLatest();
  const contextPct = tracker.getContextPercentage();
  
  const inputLine = renderBrailleLine(history.map(h => h.input), 'up');
  const outputLine = renderBrailleLine(history.map(h => h.output), 'down');
  const contextBar = renderContextBar(contextPct);
  
  return `
╭─ tokens ─────────────────────────────────────────────────────╮
│ ${inputLine}  IN ${formatTokens(latest.input)}  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ ${outputLine}  OUT ${formatTokens(latest.output)}  │
│ ──────────────────────────────────────────────────────────── │
│ ${contextBar} ${contextPct}% +${formatTokens(latest.delta)} $${latest.cost} │
╰──────────────────────────────────────────────────────────────╯
  `.trim();
}
```

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| OpenCode TUI doesn't support custom widgets | High | Use `tui.toast.show` event or external tmux pane |
| Claude Code plugin system too limited | High | Fall back to hooks + external process |
| Token data not available in events | Medium | Intercept API responses directly (like auth plugin) |
| Performance impact from rendering | Low | Debounce renders, only update on idle |
| Braille characters not rendering | Low | Provide fallback ASCII mode |

## Rollback Plan

1. Plugins are self-contained - simply remove from plugin directory
2. No system modifications required
3. No persistent state to clean up

## Success Criteria

- [ ] Widget renders correctly in OpenCode
- [ ] Widget renders correctly in Claude Code
- [ ] Real-time updates during streaming
- [ ] Accurate token counts match API usage
- [ ] Context percentage matches actual usage
- [ ] **Context resets to 0% on compaction**
- [ ] **`/cmap` shows 24-hour history**
- [ ] **Session breakdown shows compaction markers**
- [ ] Colors render correctly in supported terminals
- [ ] No noticeable performance impact
- [ ] Works with Claude Pro/Max OAuth
- [ ] Data persists across restarts (24-hour window)

## Configuration Options (Future)

```json
{
  "contextViewer": {
    "width": 60,
    "historyLength": 40,
    "position": "bottom",
    "colors": {
      "input": "cyan",
      "output": "magenta",
      "contextLow": "green",
      "contextMed": "yellow",
      "contextHigh": "red"
    },
    "showCost": false,
    "showDelta": true
  }
}
```

## Dependencies

### OpenCode Plugin
- `@opencode-ai/plugin` (types)
- No external runtime dependencies

### Claude Code Plugin
- None (uses built-in hooks system)

### Shared
- TypeScript (dev)
- Bun or Node.js runtime

## Approval

- [ ] User approved this plan
